---
title: "Data Modelling 2011-2012 Data Set"
author: "Niamh Harford 20251644"
date: "5/7/2021"
output: html_document
---

```{r}
# Load in all the data
load("~/Documents/Masters/Dissertation/Project_Git/Data/data1_11a.RData") 
head(data_11a)
# Minus Don't Know and Nas 2009-2010
```

```{r}
# Load in necessary packages
suppressMessages(library(tidyverse))
suppressMessages(library(sjPlot))
suppressMessages(library(sjlabelled))
suppressMessages(library(sjmisc))
```

##### Data Minus Don't Know and NA Values 2009-2010

```{r, results='hide'}
#Logistic regression
data_11a$Hypertension <-ifelse(data_11a$Hypertension == "Yes", 1 ,0)
data_11a$Hypertension %>% table
log_reg1 <- glm(Hypertension ~ ., data = data_11a, family = binomial())
summary(log_reg1)
```

```{r}
coefficients(log_reg1) %>% exp() %>% round(digits = 5)
```

#### **Interpretation:**
+ The odds of having hypertension if you're a female is expected to decrease by roughly 9%. 

+ For a one unit increase in age you would expect your odds of having hypertension to increase by roughly 6%.

+ When you move from American Mexican race to Other Hispanic, the odds of having hypertension increases by roughly 26%.

+ When you move from American Mexican race to Non-Hispanic White, the odds of having hypertension increases by roughly 33%.

+ When you move from American Mexican race to Non-Hispanic Black, the odds of having hypertension is expected to be roughly 2.21 times higher.

+ When you move from American Mexican race to Other Race including multi-race, the odds of having hypertension increases by roughly 31%.

+ When you move from smoking to not smoking, the odds of having hypertension decreases by roughly 20%.

+ When you move from having diabetes to not having diabetes, the odds of having hypertension decreases by roughly 46%.

+ When you move from having diabetes to borderline having diabetes, the odds of having hypertension increases by roughly 34%.

+ When you move from taking insulin to not taking insulin, the odds of having hypertension decreases by roughly 16%.

+ When you move from having chronic kidney disease to not having chronic kidney disease, the odds of having hypertension decreases by roughly 65%.

+ For a one unit increase in BMI you would expect your odds of having hypertension to increase by roughly 8%. 

+ When you move from being physically active to not being physically active, the odds of having hypertension increases by roughly 11%.

+ When you move from drinking at least 12 alcoholic drinks in a year to not, you would expect your odds to have no change.

+ When you move from never using salt to rarely, the odds of having hypertension decreases by roughly 13%.

+ When you move from never using salt to occasionally, the odds of having hypertension increases by roughly 5%.

+ When you move from never using rarely to very often, you would expect your odds to have no change.

+ For a one unit increase in potassium you would expect your odds of having hypertension to have no change.


**Variables that increases the odds of Hypertension **

+ Female
+ Not Smoking 
+ Not Having Diabetes
+ Not taking insulin
+ Not Having Chronic Kidney Disease
+ Rarely using salt in food prep



**Plotting estimates of logistic regression models**

```{r}
#2011-2012 Reduced Data
plot_model(log_reg1, vline.color = "black", sort.est = TRUE)
plot_model(log_reg1, show.values = TRUE, value.offset = .3, sort.est = T)
```





**Residuals**


```{r}
plot(log_reg1)
```

```{r, echo=FALSE, eval=FALSE}
# 2009-2010 All Data
suppressMessages(library(arm))
binnedplot(fitted(log_reg1), 
           residuals(log_reg1, type = "response"), 
           nclass = NULL, 
           xlab = "Expected Values", 
           ylab = "Average residual", 
           main = "Binned residual plot", 
           cex.pts = 0.8, 
           col.pts = 1, 
           col.int = "gray")

# The grey lines represent  Â±  2 SE bands, which we would expect to contain about 95% of the observations.
# https://bookdown.org/jefftemplewebb/IS-6489/logistic-regression.html 
```

```{r}
prob <- predict(log_reg1, type="response")
pred <- factor(ifelse(prob < .5, "No", "Yes"))
table(data_11a$Hypertension, pred)

# Error rate
(651+440)/(2296+651+440+925)*100


# MSE
mean(log_reg1$residuals^2)
```




**Smoothing Spline For BMI and Age**

```{r}
head(data_11a)
# Hypertension vs BMI
suppressMessages(library(splines))

f1 <- smooth.spline(data_11a$BMI,data_11a$Hypertension, cv = T)
# cross-validation with non-unique 'x' values seems doubtful

ggplot(data=data_11a, aes(x=BMI, y=Hypertension))+ geom_point() +
geom_line(aes(y=fitted(f1)), color="green")

f2 <- glm(Hypertension ~ bs(BMI,df=5), data=data_11a, family = binomial)
attr(bs(data_11a$BMI, df=5), "knots")

ggplot(data=data_11a, aes(x=BMI, y=Hypertension)) + geom_point() + 
  geom_line(aes(y=fitted(f2)), color= "blue") + geom_vline(xintercept = attr(bs(data_11a$BMI, df=5), "knots"), colour = "magenta")
```
```{r}
ggplot(data_11a) +
      geom_bar(aes(x = Diabetes, fill = Hypertension),position = "dodge") + 
      facet_wrap(~Race) + xlab("Smoking") + labs(fill= "Hypertension")
```

```{r}
suppressMessages(library(gam))
gam_logistic = gam(Hypertension ~ Gender + s(Age, df = 5) + Race + Smoking + Diabetes + 
                     Insulin + KidneyF + s(BMI,df=5) + PhysActivity + Alcohol + Salt +
                     Potassium, data=data_11a, family = binomial())

plot(gam_logistic, se = T, col = "green")
```


**Random Forest**

```{r}
load("~/Documents/Masters/Dissertation/Project_Git/Data/data1_11a.RData")
suppressMessages(library(randomForest))
rf <- randomForest(Hypertension ~ .,data=data_11a)
rf1 <- randomForest(Hypertension ~ .,data=data_11a, importance = T, ntree = 1000)

rf
varImpPlot(rf)
rf1
varImpPlot(rf1)

```


```{r}
#Decision Trees

suppressMessages(library(tree))
tree <- tree(Hypertension ~ BMI + Age, data=data_11a)
summary(tree)
plot(tree)
text(tree, cex=.5, pretty=0)

tree1 <- tree(Hypertension ~ ., data=data_11a)
summary(tree1)
plot(tree1)
text(tree1, cex=.5, pretty=0)

suppressMessages(library(rpart))
f1 <- rpart(Hypertension ~ ., data=data_11a)
plot(f1)
text(f1, cex=.5, pretty = 0)
```

```{r}
# Neural Networks
load("~/Documents/Masters/Dissertation/Project_Git/Data/data1_11a.RData")

suppressMessages(library(nnet))
set.seed(1)
nn <- nnet(Hypertension ~ ., data=data_11a, size=10)
nn
head(data_11a$Hypertension)
pred <- predict(nn, data_11a, type="class")
head(pred)
table(data_11a$Hypertension, pred)
#error rate
(593+499)/(2237+593+499+983)*100

mean( data_11a$Hypertension != pred)


suppressMessages(library(devtools))
suppressMessages(source_url('https://gist.githubusercontent.com/fawda123/7471137/raw/466c1474d0a505ff044412703516c34f1a4684a5/nnet_plot_update.r'))
 
plot.nnet(nn)
```



```{r, results='hide'}
# Logistic Regression - Interaction with Gender

data_11a$Hypertension <-ifelse(data_11a$Hypertension == "Yes", 1 ,0)
data_11a$Hypertension %>% table
log_reg_gender <- glm(Hypertension ~ .*Gender, data = data_11a, family = binomial())
summary(log_reg_gender)
```

```{r}
coefficients(log_reg_gender) %>% exp() %>% round(digits = 4)
```

#### **Interpretation:**
+ The odds of having hypertension if you're a female is expected to decrease by roughly 65%.. 

+ For a one unit increase in age if you are male, you would expect your odds of having hypertension to increase by roughly 5%.

+ When you move from American Mexican race to Other Hispanic if you are male, the odds of having hypertension increases by roughly 51%.

+ When you move from American Mexican race to Non-Hispanic White if you are male, the odds of having hypertension increases by roughly 66%.

+ When you move from American Mexican race to Non-Hispanic Black if you are male, the odds of having hypertension is expected to be roughly 2.64 times higher.

+ When you move from American Mexican race to Other Race including multi-racial, the odds of having hypertension is expected to increase by roughly 48%.

+ When you move from smoking to not smoking if you are male, the odds of having hypertension decreases by roughly 19%.

+ When you move from having diabetes to not having diabetes if you are male, the odds of having hypertension decreases by roughly 44%.

+ When you move from having diabetes to borderline having diabetes if you are male, the odds of having hypertension increases by roughly 12%.

+ When you move from taking insulin to not taking insulin if you are male, the odds of having hypertension decreases by roughly 21%.

+ When you move from having chronic kidney disease to not having chronic kidney disease if you are male, the odds of having hypertension decreases by roughly 62%.

+ For a one unit increase in BMI if you are male, you would expect your odds of having hypertension to increase by roughly 7%. 

+ When you move from being physically active to not being physically active if you are male, the odds of having hypertension increases by roughly 10%.

+ When you move from drinking at least 12 alcoholic drinks in a year to not if you are male, the odds of having hypertension inreases by roughly 2%.

+ When you move from never using salt to rarely if you are male, the odds of having hypertension decreases by roughly 8%.

+ When you move from never using salt to occasionally if you are male, the odds of having hypertension increases by roughly 3%.

+ When you move from never using rarely to very often if you are male, the odds of having hypertension increases by roughly 8%.

+ For a one unit increase in potassium if you are male, you would expect no change in your odds.

+ For a one unit increase in age if you are female, the odds of having hypertension increases by roughly 2%.

+ When you move from American Mexican race to Other Hispanic if you are female, the odds of having hypertension decreases by roughly 34%.

+ When you move from American Mexican race to Non-Hispanic White if you are female, the odds of having hypertension decreases by roughly 41%.

+ When you move from American Mexican race to Non-Hispanic Black if you are female, the odds of having hypertension decreases by roughly 34%.

+ When you move from American Mexican race to Other Race including multi-racial if you are female, the odds of having hypertension decreases by roughly 24%.

+ When you move from smoking to not smoking if you are female, the odds of having hypertension decreases by roughly 7%.

+ When you move from having diabetes to not having diabetes if you are female, the odds of having hypertension decreases by roughly 8%.

+ When you move from having diabetes to borderline having diabetes if you are female, the odds of having hypertension decreases by roughly 32%.

+ When you move from taking insulin to not taking insulin if you are female, the odds of having hypertension increases by roughly 19%.

+ When you move from having chronic kidney disease to not having chronic kidney disease if you are female, the odds of having hypertension decreases by roughly 16%.

+ For a one unit increase in BMI if you are female, you would expect your odds of having hypertension to decrease by roughly 2%. 

+ When you move from being physically active to not being physically active if you are female, you would expect the odds to have no change.

+ When you move from drinking at least 12 alcoholic drinks in a year to not if you are female, the odds of having hypertension decreases by roughly 10%.

+ When you move from never using salt to rarely if you are female, the odds of having hypertension decreases by roughly 12%.

+ When you move from never using salt to occasionally if you are female, the odds of having hypertension increases by roughly 4%.

+ When you move from never using salt to very often if you are female, the odds of having hypertension decreases by roughly 16%.

+ For a one unit increase in potassium if you are female, you would expect your odds to have no change.

```{r}
AIC(log_reg1)
AIC(log_reg_gender)
```

```{r, echo=FALSE,eval=F}
#Predict the model

mean(log_reg1$residuals^2)
mean(log_reg_gender$residuals^2)

load("~/Documents/Masters/Dissertation/Project_Git/Data/data1_11a.RData") 

data = data.frame(predicted = predict(log_reg1), actual = data_11a$Hypertension)

ggplot(data = data, aes(x = predicted, y = actual)) + geom_point() + geom_smooth(method = lm, se = F) + labs(title = "Actual vs Predicted Mesostigmata Abundance Values")



data1 = data.frame(predicted = predict(log_reg_gender), actual = 
                    na.omit(data_11a$Hypertension))


ggplot(data = data1, aes(x = predicted, y = actual)) + geom_point() + geom_smooth(method = lm, se = F) + labs(title = " Actual vs Predicted Mesostigmata Abundance Values,\n Minus outliers")
```



