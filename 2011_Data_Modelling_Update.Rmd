---
title: "Data Modelling 2011-2012 Data Set"
author: "Niamh Harford 20251644"
date: "6/16/2021"
output: html_document
---


```{r}
# Load in necessary packages
suppressMessages(library(tidyverse))
suppressMessages(library(sjPlot))
suppressMessages(library(sjlabelled))
suppressMessages(library(sjmisc))
suppressMessages(library(MASS))
suppressMessages(library(car))
suppressMessages(library(arm))
```


```{r}
# Load in all the data
load("Data/data1_11a.RData") 

head(data_11a)
nrow(data_11a)
```


```{r}
data_11a$Hypertension <-factor(ifelse(data_11a$Hypertension == "Yes", 1 ,0))

f1 <- glm(Hypertension ~ .,data=data_11a, family = binomial() )
f2 <- glm(Hypertension ~ Gender + Age+I(Age^2) + Race + Smoking + Diabetes + 
                     Insulin + KidneyF + BMI+I(BMI^2) + PhysActivity + Alcohol + Salt +
                     Potassium, data=data_11a, family = binomial())

anova(f1, f2, test="LRT")  # keep the quadratic terms


f3 <- glm(Hypertension ~ (Age+I(Age^2) + Race + Smoking + Diabetes+
                     Insulin + KidneyF + BMI+I(BMI^2) + PhysActivity + Alcohol + Salt +
                     Potassium)*Gender, data=data_11a, family = binomial())
anova(f2,f3, test="LRT")  # so some interactions are good

Anova(f3)

f4 <-glm(Hypertension ~ (Age+I(Age^2) + BMI+I(BMI^2))*Gender+Race + Smoking + Diabetes + 
                     Insulin + KidneyF + PhysActivity + Alcohol + Salt +
                     Potassium, data=data_11a, family = binomial())
anova(f4,f3, test="LRT")  # confirms only need two interactions


# Continue with f4 - that has two quadratic terms and two interactions
```


```{r}
summary(f4)
coefficients(f4) %>% exp() %>% round(digits = 5)
```


```{r}
# better than residualPlots
binnedplot(data_11a$Age, 
           residuals(f4, type = "response"), 
           nclass = NULL, 
           xlab = "Age", 
           ylab = "Average residual", 
           main = "Binned residual plot - Age", 
           cex.pts = 0.8, 
           col.pts = c("red","blue")[as.numeric(data_11a$Gender)], 
           col.int = "black")


binnedplot(fitted(f3), 
           residuals(f4, type = "response"), 
           nclass = NULL, 
           xlab = "Expected Values", 
           ylab = "Average residual", 
           main = "Binned residual plot", 
           cex.pts = 0.8, 
           col.pts = "blue", 
           col.int = "black")
```




```{r}
plot_model(f4, vline.color = "black", sort.est = TRUE,colors = "Accent")
```

```{r, fig.height=16,fig.width=16}
suppressMessages(library(randomForest))
suppressMessages(library(e1071))
suppressMessages(library(DALEX))
suppressMessages(library(rms))
suppressMessages(library(nnet))
suppressMessages(library(devtools))
suppressMessages(source_url('https://gist.githubusercontent.com/fawda123/7471137/raw/466c1474d0a505ff044412703516c34f1a4684a5/nnet_plot_update.r'))

model_log1 <-glm(Hypertension ~ (Age+I(Age^2) + BMI+I(BMI^2))*Gender+Race + Smoking +                   Diabetes + Insulin + KidneyF + PhysActivity + Alcohol + Salt +
            Potassium, data=data_11a, family = binomial())


model_rf <- randomForest(Hypertension ~ .,data_11a, importance = T)


model_nn <- nnet(Hypertension ~ ., data=data_11a, size=6)

 

hypn <- as.numeric(data_11a$Hypertension)-1
ex_rf <- explain(model_rf, data = data_11a, y = hypn )
ex_log <- explain(model_log1, data = data_11a, y = hypn)
ex_nn <- explain(model_nn, data = data_11a, y = hypn)



plot(model_profile(ex_rf, variables = c("Gender", "Race","Smoking", "Diabetes"))) + ggtitle("Response for Random Forest")
plot(model_profile(ex_rf, variables = c("Insulin","KidneyF","PhysActivity", "Alcohol", "Salt"))) + ggtitle("Response for Random Forest")
plot(model_profile(ex_rf)) + ggtitle("Response for Random Forest")
plot(model_profile(ex_log, variables = c("Gender", "Race","Smoking", "Diabetes"))) + ggtitle("Response for Logistic Regression")
plot(model_profile(ex_log, variables = c("Insulin","KidneyF","PhysActivity", "Alcohol", "Salt"))) + ggtitle("Response for Logistic Regression")
plot(model_profile(ex_log)) + ggtitle("Response for Logistic Regression")
plot(model_profile(ex_nn, variables = c("Gender", "Race","Smoking", "Diabetes"))) + ggtitle("Response for Neural Network")
plot(model_profile(ex_nn, variables = c("Insulin","KidneyF","PhysActivity", "Alcohol", "Salt"))) + ggtitle("Response for Neural Network")
plot(model_profile(ex_nn)) + ggtitle("Response for Neural Network")

 


plot(model_profile(ex_log,groups="Gender")) + ggtitle("Response for Random Forest")
plot(model_profile(ex_rf,groups="Gender")) + ggtitle("Response for Logistic Regression")
plot(model_profile(ex_nn,groups="Gender")) + ggtitle("Response for Neural Network")


 


# look at model_performance and plot model_performance for nice way of getting roc and model summaries.

 

model_performance(ex_rf)
model_performance(ex_log)
model_performance(ex_nn)
plot(model_performance(ex_rf),model_performance(ex_log),model_performance(ex_nn), geom = "roc") 
```


```{r}

# Gender and Salt
plot(model_profile(ex_rf, variables = c("Gender","Salt")), model_profile(ex_nn, , variables = c("Gender","Salt")), model_profile(ex_log, , variables = c("Gender","Salt"))) + ggtitle("Response for Gender and Salt")
                                                              
# Race 
plot(model_profile(ex_rf, variable = "Race"), model_profile(ex_nn, , variable = "Race"), model_profile(ex_log, , variable = "Race")) + ggtitle("Response for Race")                                                              

# Smoking and Diabetes
plot(model_profile(ex_rf, variables = c("Smoking", "Diabetes")), model_profile(ex_nn, , variables = c("Smoking", "Diabetes")), model_profile(ex_log, , variables = c("Smoking", "Diabetes"))) + ggtitle("Response for Smoking and Diabetes")


# Insulin and KidneyF
plot(model_profile(ex_rf, variables = c("Insulin","KidneyF")), model_profile(ex_nn, , variables = c("Insulin","KidneyF")), model_profile(ex_log, , variables = c("Insulin","KidneyF"))) + ggtitle("Response for Insulin and KidneyF")


# Physical Activity and Alcohol
plot(model_profile(ex_rf, variables = c("PhysActivity", "Alcohol")), model_profile(ex_nn, , variables = c("PhysActivity", "Alcohol")), model_profile(ex_log, , variables = c("PhysActivity", "Alcohol"))) + ggtitle("Response for Physical Activity and Alcohol")

# Age, BMI and Potassium
plot(model_profile(ex_nn), model_profile(ex_rf), model_profile(ex_log)) + ggtitle("Response for Age, BMI and Potassium")
```


```{r}
library(condvis2)

#Click on show probs on the shiny app. The plots are like the partial dependence plots from DALEX, except the DALEX plots are averaging curves over all observations. You can see from both DALEX and condvis2 (switch from Age to BMI in the condvis2 menu) that the glm curve decreasing for high BMIs for males is likely not a good fit and probably does not make sense

condvis(data_11a, model=list(rf=model_rf, glm=model_log1, nn =model_nn), response="Hypertension", sectionvars=c("Age", "Gender"))
```


